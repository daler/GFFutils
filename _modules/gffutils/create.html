<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>gffutils.create &mdash; gffutils 0.11.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> gffutils
          </a>
              <div class="version">
                0.11.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../database-import.html">Importing data into a database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../database-schema.html">Database schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../database-ids.html">Database IDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gtf.html">GTF files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dialect.html">Dialects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../attributes.html">Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developers.html">Developerâ€™s docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../meta.html">Meta-docs (docs about the docs)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">gffutils</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>gffutils.create</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for gffutils.create</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
<span class="kn">from</span> <span class="nn">gffutils</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">gffutils</span> <span class="kn">import</span> <span class="n">version</span>
<span class="kn">from</span> <span class="nn">gffutils</span> <span class="kn">import</span> <span class="n">bins</span>
<span class="kn">from</span> <span class="nn">gffutils</span> <span class="kn">import</span> <span class="n">helpers</span>
<span class="kn">from</span> <span class="nn">gffutils</span> <span class="kn">import</span> <span class="n">feature</span>
<span class="kn">from</span> <span class="nn">gffutils</span> <span class="kn">import</span> <span class="n">interface</span>
<span class="kn">from</span> <span class="nn">gffutils</span> <span class="kn">import</span> <span class="n">iterators</span>
<span class="kn">from</span> <span class="nn">gffutils.exceptions</span> <span class="kn">import</span> <span class="n">EmptyInputError</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">deprecation_handler</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    As things change from version to version, deal with them here.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># After reconsidering, let&#39;s leave `infer_gene_extent` for another release.</span>
    <span class="c1"># But when it&#39;s time to deprecate it, use this code:</span>
    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;infer_gene_extent&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;infer_gene_extent&#39; is deprecated as of version 0.8.4 in &quot;</span>
                <span class="s2">&quot;favor of more granular control over inferring genes and/or &quot;</span>
                <span class="s2">&quot;transcripts.  The previous default was &quot;</span>
                <span class="s2">&quot;&#39;infer_gene_extent=True`, which corresponds to the new &quot;</span>
                <span class="s2">&quot;defaults &quot;</span>
                <span class="s2">&quot;&#39;disable_infer_genes=False&#39; and &quot;</span>
                <span class="s2">&quot;&#39;disable_infer_transcripts=False&#39;. Please see the docstring &quot;</span>
                <span class="s2">&quot;for gffutils.create_db for details.&quot;</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;unhandled kwarg in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_DBCreator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">dbfn</span><span class="p">,</span>
        <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">id_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">merge_strategy</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
        <span class="n">checklines</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_dialect_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">from_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">dialect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default_encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="n">disable_infer_genes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">disable_infer_transcripts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">infer_gene_extent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">force_merge_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">text_factory</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">OptimizedUnicode</span><span class="p">,</span>
        <span class="n">pragmas</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">default_pragmas</span><span class="p">,</span>
        <span class="n">_keep_tempfiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">directives</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Base class for _GFFDBCreator and _GTFDBCreator; see create_db()</span>
<span class="sd">        function for docs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keep_tempfiles</span> <span class="o">=</span> <span class="n">_keep_tempfiles</span>
        <span class="k">if</span> <span class="n">force_merge_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">force_merge_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">merge_strategy</span> <span class="o">==</span> <span class="s2">&quot;merge&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">force_merge_fields</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Can&#39;t merge start/end fields since &quot;</span> <span class="s2">&quot;they must be integers&quot;</span>
                <span class="p">)</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">force_merge_fields</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">([</span><span class="s2">&quot;frame&quot;</span><span class="p">,</span> <span class="s2">&quot;strand&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">warn</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> field will be merged for features with the same ID; &quot;</span>
                    <span class="s2">&quot;this may result in unusable features.&quot;</span> <span class="o">%</span> <span class="n">w</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">force_merge_fields</span> <span class="o">=</span> <span class="n">force_merge_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pragmas</span> <span class="o">=</span> <span class="n">pragmas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_strategy</span> <span class="o">=</span> <span class="n">merge_strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_encoding</span> <span class="o">=</span> <span class="n">default_encoding</span>
        <span class="k">if</span> <span class="n">directives</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">directives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directives</span> <span class="o">=</span> <span class="n">directives</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">infer_gene_extent</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;&#39;infer_gene_extent&#39; will be deprecated. For now, &quot;</span>
                <span class="s2">&quot;the following equivalent values were automatically &quot;</span>
                <span class="s2">&quot;set: &#39;disable_infer_genes=True&#39;, &quot;</span>
                <span class="s2">&quot;&#39;disable_infer_transcripts=True&#39;. Please use these &quot;</span>
                <span class="s2">&quot;instead in the future.&quot;</span>
            <span class="p">)</span>
            <span class="n">disable_infer_genes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">disable_infer_transcripts</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">disable_infer_genes</span> <span class="o">=</span> <span class="n">disable_infer_genes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_infer_transcripts</span> <span class="o">=</span> <span class="n">disable_infer_transcripts</span>

        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfn</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">dbfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbfn</span> <span class="o">=</span> <span class="n">dbfn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_spec</span> <span class="o">=</span> <span class="n">id_spec</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dbfn</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbfn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">dbfn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_verbose</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">text_factory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;setting text factory to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">text_factory</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">text_factory</span> <span class="o">=</span> <span class="n">text_factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_logger_level</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">iterators</span><span class="o">.</span><span class="n">DataIterator</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">checklines</span><span class="o">=</span><span class="n">checklines</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">force_dialect_check</span><span class="o">=</span><span class="n">force_dialect_check</span><span class="p">,</span>
            <span class="n">from_string</span><span class="o">=</span><span class="n">from_string</span><span class="p">,</span>
            <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># keys are featuretypes, values are integers. Results in unique,</span>
        <span class="c1"># derived feature IDs like &quot;exon_94&quot;.</span>
        <span class="k">if</span> <span class="s2">&quot;_autoincrements&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autoincrements</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_autoincrements&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autoincrements</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s2">&quot;debug&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

    <span class="k">def</span> <span class="nf">_increment_featuretype_autoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_autoincrements</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autoincrements</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_id_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a Feature from self.iterator, figure out what the ID should be.</span>

<span class="sd">        This uses `self.id_spec` to identify the ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If id_spec is a string or callable, convert to iterable for later</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_spec</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">id_key</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_spec</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_spec</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">):</span>
            <span class="n">id_key</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_spec</span><span class="p">]</span>

        <span class="c1"># If dict, then assume it&#39;s a feature -&gt; attribute mapping, e.g.,</span>
        <span class="c1"># {&#39;gene&#39;: &#39;gene_id&#39;} for GTF</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_spec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">id_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_spec</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">featuretype</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_key</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                    <span class="n">id_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_key</span><span class="p">]</span>

            <span class="c1"># Otherwise, use default auto-increment.</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment_featuretype_autoid</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">featuretype</span><span class="p">)</span>

        <span class="c1"># Otherwise assume it&#39;s an iterable.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">id_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_spec</span>

        <span class="c1"># Then try them in order, returning the first one that works:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">id_key</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">):</span>
                <span class="n">_id</span> <span class="o">=</span> <span class="n">k</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_id</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;autoincrement:&quot;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment_featuretype_autoid</span><span class="p">(</span><span class="n">_id</span><span class="p">[</span><span class="mi">14</span><span class="p">:])</span>
                    <span class="k">return</span> <span class="n">_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># use GFF fields rather than attributes for cases like :seqid:</span>
                <span class="c1"># or :strand:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;:&quot;</span><span class="p">):</span>
                    <span class="c1"># No trailing [0] here to get first item -- only attributes</span>
                    <span class="c1"># key/vals are forced into lists, not standard GFF fields</span>
                    <span class="c1"># like seqid or strand.</span>
                    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;The ID field </span><span class="si">{}</span><span class="s2"> has more than one value but &quot;</span>
                                <span class="s2">&quot;a single value is required for a primary key in the &quot;</span>
                                <span class="s2">&quot;database. Consider using a custom id_spec to &quot;</span>
                                <span class="s2">&quot;convert these multiple values into a single &quot;</span>
                                <span class="s2">&quot;value&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                        <span class="k">pass</span>
        <span class="c1"># If we get here, then default autoincrement</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment_featuretype_autoid</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">featuretype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ID</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">_SELECT</span> <span class="o">+</span> <span class="s2">&quot; WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ID</span><span class="p">,))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">feature</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="o">.</span><span class="n">dialect</span><span class="p">,</span> <span class="o">**</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">merge_strategy</span><span class="p">,</span> <span class="n">add_duplicate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Different merge strategies upon name conflicts.</span>

<span class="sd">        &quot;error&quot;:</span>
<span class="sd">            Raise error</span>

<span class="sd">        &quot;warning&quot;</span>
<span class="sd">            Log a warning, which indicates that all future instances of the</span>
<span class="sd">            same ID will be ignored</span>

<span class="sd">        &quot;merge&quot;:</span>
<span class="sd">            Combine old and new attributes -- but only if everything else</span>
<span class="sd">            matches; otherwise error. This can be slow, but is thorough.</span>

<span class="sd">        &quot;create_unique&quot;:</span>
<span class="sd">            Autoincrement based on the ID, always creating a new ID.</span>

<span class="sd">        &quot;replace&quot;:</span>
<span class="sd">            Replaces existing database feature with `f`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">merge_strategy</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Duplicate ID </span><span class="si">{0.id}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">merge_strategy</span> <span class="o">==</span> <span class="s2">&quot;warning&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Duplicate lines in file for id &#39;</span><span class="si">{0.id}</span><span class="s2">&#39;; &quot;</span>
                <span class="s2">&quot;ignoring all but the first&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">merge_strategy</span>

        <span class="k">elif</span> <span class="n">merge_strategy</span> <span class="o">==</span> <span class="s2">&quot;replace&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">merge_strategy</span>

        <span class="c1"># This is by far the most complicated strategy.</span>
        <span class="k">elif</span> <span class="n">merge_strategy</span> <span class="o">==</span> <span class="s2">&quot;merge&quot;</span><span class="p">:</span>

            <span class="c1"># Recall that if we made it to this method, there was at least one</span>
            <span class="c1"># ID collision.</span>

            <span class="c1"># This will eventually contain the features that match ID AND that</span>
            <span class="c1"># match non-attribute fields like start, stop, strand, etc.</span>
            <span class="n">features_to_merge</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Iterate through all features that have the same ID according to</span>
            <span class="c1"># the id_spec provided.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="s2">&quot;debug&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;candidates with same idspec: </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_candidate_merges</span><span class="p">(</span><span class="n">f</span><span class="p">)])</span>
                <span class="p">)</span>

            <span class="c1"># If force_merge_fields was provided, don&#39;t check them even if</span>
            <span class="c1"># they&#39;re different. We are assuming the attributes field will be</span>
            <span class="c1"># different, hence the [:-1]</span>
            <span class="n">_gffkeys_to_check</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">_gffkeys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force_merge_fields</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">existing_feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_candidate_merges</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="c1"># Check other GFF fields (if not specified in</span>
                <span class="c1"># self.force_merge_fields) to make sure they match.</span>
                <span class="n">other_attributes_same</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_gffkeys_to_check</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">existing_feature</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                        <span class="n">other_attributes_same</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="n">other_attributes_same</span><span class="p">:</span>
                    <span class="c1"># All the other GFF fields match. So this existing feature</span>
                    <span class="c1"># should be merged.</span>
                    <span class="n">features_to_merge</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">existing_feature</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;same attributes between:</span><span class="se">\n</span><span class="s2">existing: </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">this    : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">existing_feature</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The existing feature&#39;s GFF fields don&#39;t match, so don&#39;t</span>
                    <span class="c1"># append anything.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;different attributes between:</span><span class="se">\n</span><span class="s2">existing: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;this    : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">existing_feature</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_to_merge</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># No merge candidates found, so we should make a new ID for</span>
                <span class="c1"># this feature. This can happen when idspecs match, but other</span>
                <span class="c1"># fields (like start/stop) are different.  Call this method</span>
                <span class="c1"># again, but using the &quot;create_unique&quot; strategy, and then</span>
                <span class="c1"># record the newly-created ID in the duplicates table.</span>
                <span class="n">orig_id</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span>
                <span class="n">uniqued_feature</span><span class="p">,</span> <span class="n">merge_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_merge</span><span class="p">(</span>
                    <span class="n">f</span><span class="p">,</span> <span class="n">merge_strategy</span><span class="o">=</span><span class="s2">&quot;create_unique&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_duplicate</span><span class="p">(</span><span class="n">orig_id</span><span class="p">,</span> <span class="n">uniqued_feature</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">uniqued_feature</span><span class="p">,</span> <span class="n">merge_strategy</span>

            <span class="c1"># Whoo! Found some candidates to merge.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;num candidates: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_to_merge</span><span class="p">))</span>

                <span class="c1"># This is the attributes dictionary we&#39;ll be modifying.</span>
                <span class="n">merged_attributes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>

                <span class="c1"># Keep track of non-attribute fields (this will be an empty</span>
                <span class="c1"># dict if no force_merge_fields)</span>
                <span class="n">final_fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">set</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">field</span><span class="p">)]))</span>
                        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_merge_fields</span>
                    <span class="p">]</span>
                <span class="p">)</span>

                <span class="c1"># Update the attributes</span>
                <span class="k">for</span> <span class="n">existing_feature</span> <span class="ow">in</span> <span class="n">features_to_merge</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">merging</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">existing_feature</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">existing_feature</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">merged_attributes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])</span>
                        <span class="n">v</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">existing_feature</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">merged_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

                    <span class="c1"># Update the set of non-attribute fields found so far</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_merge_fields</span><span class="p">:</span>
                        <span class="n">final_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">existing_feature</span><span class="p">,</span> <span class="n">field</span><span class="p">)])</span>

                <span class="c1"># Set the merged attributes</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">merged_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">merged_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="n">existing_feature</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">merged_attributes</span>

                <span class="c1"># Set the final merged non-attributes</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">final_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">existing_feature</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">v</span><span class="p">))))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MERGED:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">existing_feature</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">existing_feature</span><span class="p">,</span> <span class="n">merge_strategy</span>

        <span class="k">elif</span> <span class="n">merge_strategy</span> <span class="o">==</span> <span class="s2">&quot;create_unique&quot;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment_featuretype_autoid</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">merge_strategy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid merge strategy &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">merge_strategy</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_add_duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idspecid</span><span class="p">,</span> <span class="n">newid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a duplicate ID (as identified by id_spec) and its new ID to the</span>
<span class="sd">        duplicates table so that they can be later searched for merging.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        newid : str</span>
<span class="sd">            The primary key used in the features table</span>

<span class="sd">        idspecid : str</span>
<span class="sd">            The ID identified by id_spec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                INSERT INTO duplicates</span>
<span class="sd">                (idspecid, newid)</span>
<span class="sd">                VALUES (?, ?)&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">idspecid</span><span class="p">,</span> <span class="n">newid</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                INSERT INTO duplicates</span>
<span class="sd">                (idspecid, newid)</span>
<span class="sd">                VALUES (?, ?)&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">idspecid</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_encoding</span><span class="p">),</span>
                    <span class="n">newid</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_encoding</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;added id=</span><span class="si">%s</span><span class="s2">; new=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idspecid</span><span class="p">,</span> <span class="n">newid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_candidate_merges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identifies those features that originally had the same ID as `f`</span>
<span class="sd">        (according to the id_spec), but were modified because of duplicate</span>
<span class="sd">        IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_feature</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">constants</span><span class="o">.</span><span class="n">_SELECT</span>
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            JOIN duplicates ON</span>
<span class="s2">            duplicates.newid = features.id WHERE duplicates.idspecid = ?&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="o">.</span><span class="n">dialect</span><span class="p">,</span> <span class="o">**</span><span class="n">i</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">candidates</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_populate_from_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_update_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_drop_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">INDEXES</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_pragmas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pragmas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set pragmas for the current database connection.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pragmas : dict</span>
<span class="sd">            Dictionary of pragmas; see constants.default_pragmas for a template</span>
<span class="sd">            and http://www.sqlite.org/pragma.html for a full list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pragmas</span> <span class="o">=</span> <span class="n">pragmas</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="s2">&quot;;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;PRAGMA </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pragmas</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Table creation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">sqlite_version_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_pragmas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pragmas</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">SCHEMA</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Various last-minute stuff to perform after file has been parsed and</span>
<span class="sd">        imported.</span>

<span class="sd">        In general, if you&#39;ll be adding stuff to the meta table, do it here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">directives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directives</span>
        <span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                      INSERT INTO directives VALUES (?)</span>
<span class="sd">                      &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">((</span><span class="n">i</span><span class="p">,)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">directives</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            INSERT INTO meta (version, dialect)</span>
<span class="sd">            VALUES (:version, :dialect)&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="n">helpers</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="o">.</span><span class="n">dialect</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            INSERT OR REPLACE INTO autoincrements VALUES (?, ?)</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_autoincrements</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
        <span class="p">)</span>

        <span class="c1"># These indexes are *well* worth the effort and extra storage: over</span>
        <span class="c1"># 500x speedup on code like this:</span>
        <span class="c1">#</span>
        <span class="c1">#   genes = []</span>
        <span class="c1">#   for i in db.features_of_type(&#39;snoRNA&#39;):</span>
        <span class="c1">#       for k in db.parents(i, level=1, featuretype=&#39;gene&#39;):</span>
        <span class="c1">#           genes.append(k.id)</span>
        <span class="c1">#</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating relations(parent) index&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS relationsparent&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX relationsparent ON relations (parent)&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating relations(child) index&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS relationschild&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX relationschild ON relations (child)&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating features(featuretype) index&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS featuretype&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX featuretype ON features (featuretype)&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating features (seqid, start, end) index&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS seqidstartend&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX seqidstartend ON features (seqid, start, end)&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating features (seqid, start, end, strand) index&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS seqidstartendstrand&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;CREATE INDEX seqidstartendstrand ON features (seqid, start, end, strand)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># speeds computation 1000x in some cases</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running ANALYZE features&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ANALYZE features&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="o">.</span><span class="n">warnings</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls various methods sequentially in order to fully build the</span>
<span class="sd">        database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calls each of these methods in order.  _populate_from_lines and</span>
        <span class="c1"># _update_relations must be implemented in subclasses.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_tables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_from_lines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_relations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize</span><span class="p">()</span>

    <span class="c1"># TODO: not sure this is used anywhere</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_from_lines</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_relations</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a query directly on the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">i</span>

    <span class="k">def</span> <span class="nf">_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert a feature into the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">_INSERT</span><span class="p">,</span> <span class="n">feature</span><span class="o">.</span><span class="n">astuple</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">_INSERT</span><span class="p">,</span> <span class="n">feature</span><span class="o">.</span><span class="n">astuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_encoding</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert a feature into the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">_UPDATE</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">astuple</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">_INSERT</span><span class="p">,</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">astuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_encoding</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
            <span class="p">)</span>


<span class="k">class</span> <span class="nc">_GFFDBCreator</span><span class="p">(</span><span class="n">_DBCreator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _DBCreator subclass specifically for working with GFF files.</span>

<span class="sd">        create_db() delegates to this class -- see that function for docs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_GFFDBCreator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_populate_from_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drop_indexes</span><span class="p">()</span>
        <span class="n">last_perc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Populating features&quot;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Populating features table and first-order relations: &quot;</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> features</span><span class="se">\r</span><span class="s2">&quot;</span>

        <span class="c1"># c.executemany() was not as much of an improvement as I had expected.</span>
        <span class="c1">#</span>
        <span class="c1"># Compared to a benchmark of doing each insert separately:</span>
        <span class="c1"># executemany using a list of dicts to iterate over is ~15% slower</span>
        <span class="c1"># executemany using a list of tuples to iterate over is ~8% faster</span>
        <span class="n">features_seen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">_features</span><span class="p">,</span> <span class="n">_relations</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">features_seen</span> <span class="o">=</span> <span class="n">i</span>

            <span class="c1"># Percent complete</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="c1"># TODO: handle ID creation here...should be combined with the</span>
            <span class="c1"># INSERT below (that is, don&#39;t IGNORE below but catch the error and</span>
            <span class="c1"># re-try with a new ID).  However, is this doable with an</span>
            <span class="c1"># execute-many?</span>
            <span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_handler</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
                <span class="n">fixed</span><span class="p">,</span> <span class="n">final_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_merge</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_strategy</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">final_strategy</span> <span class="o">==</span> <span class="s2">&quot;merge&quot;</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        UPDATE features SET attributes = ?</span>
<span class="sd">                        WHERE id = ?</span>
<span class="sd">                        &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">fixed</span><span class="o">.</span><span class="n">attributes</span><span class="p">),</span> <span class="n">fixed</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="c1"># For any additional fields we&#39;re merging, update those as</span>
                    <span class="c1"># well.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_merge_fields</span><span class="p">:</span>
                        <span class="n">_set_clause</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = ?&quot;</span> <span class="o">%</span> <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_merge_fields</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">fixed</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_merge_fields</span>
                        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">fixed</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                            UPDATE features SET %s</span>
<span class="sd">                            WHERE id = ?</span>
<span class="sd">                            &quot;&quot;&quot;</span>
                            <span class="o">%</span> <span class="n">_set_clause</span><span class="p">,</span>
                            <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
                        <span class="p">)</span>

                <span class="k">elif</span> <span class="n">final_strategy</span> <span class="o">==</span> <span class="s2">&quot;replace&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">final_strategy</span> <span class="o">==</span> <span class="s2">&quot;create_unique&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;Parent&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;Parent&quot;</span><span class="p">]:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        INSERT OR IGNORE INTO relations VALUES</span>
<span class="sd">                        (?, ?, 1)</span>
<span class="sd">                        &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="n">features_seen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EmptyInputError</span><span class="p">(</span><span class="s2">&quot;No lines parsed -- was an empty file provided?&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating relations&quot;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># TODO: pre-compute indexes?</span>
        <span class="c1"># c.execute(&#39;CREATE INDEX ids ON features (id)&#39;)</span>
        <span class="c1"># c.execute(&#39;CREATE INDEX parentindex ON relations (parent)&#39;)</span>
        <span class="c1"># c.execute(&#39;CREATE INDEX childindex ON relations (child)&#39;)</span>
        <span class="c1"># self.conn.commit()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keep_tempfiles</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_tempfiles</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;.gffutils&quot;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>

            <span class="c1"># Here we look for &quot;grandchildren&quot; -- for each ID, get the child</span>
            <span class="c1"># (parenthetical subquery below); then for each of those get *its*</span>
            <span class="c1"># child (main query below).</span>
            <span class="c1">#</span>
            <span class="c1"># Results are written to temp file so that we don&#39;t read and write at</span>
            <span class="c1"># the same time, which would slow things down considerably.</span>

            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id FROM features&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">c2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                           SELECT child FROM relations WHERE parent IN</span>
<span class="sd">                           (SELECT child FROM relations WHERE parent = ?)</span>
<span class="sd">                           &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="nb">tuple</span><span class="p">(</span><span class="n">parent</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">grandchild</span> <span class="ow">in</span> <span class="n">c2</span><span class="p">:</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">parent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grandchild</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">relations_generator</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fout</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
                    <span class="n">parent</span><span class="p">,</span> <span class="n">child</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="nb">dict</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="o">=</span><span class="n">child</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            INSERT OR IGNORE INTO relations VALUES</span>
<span class="sd">            (:parent, :child, :level)</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">relations_generator</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># TODO: Index creation.  Which ones affect performance?</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS binindex&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX binindex ON features (bin)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_tempfiles</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fout</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_GTFDBCreator</span><span class="p">(</span><span class="n">_DBCreator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create_db() delegates to this class -- see that function for docs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transcript_key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;transcript_key&quot;</span><span class="p">,</span> <span class="s2">&quot;transcript_id&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;gene_key&quot;</span><span class="p">,</span> <span class="s2">&quot;gene_id&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subfeature</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;subfeature&quot;</span><span class="p">,</span> <span class="s2">&quot;exon&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_GTFDBCreator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_populate_from_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Populating features table and first-order relations: </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="s2">&quot;features</span><span class="se">\r</span><span class="s2">&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># Only check this many features to see if it&#39;s a gene or transcript and</span>
        <span class="c1"># issue the appropriate warning.</span>
        <span class="n">gene_and_transcript_check_limit</span> <span class="o">=</span> <span class="mi">1000</span>

        <span class="n">last_perc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lines_seen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>

            <span class="c1"># See issues #48 and #20.</span>
            <span class="k">if</span> <span class="n">lines_seen</span> <span class="o">&lt;</span> <span class="n">gene_and_transcript_check_limit</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">featuretype</span> <span class="o">==</span> <span class="s2">&quot;transcript&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_infer_transcripts</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;It appears you have a transcript feature in your GTF &quot;</span>
                        <span class="s2">&quot;file. You may want to use the &quot;</span>
                        <span class="s2">&quot;`disable_infer_transcripts=True` &quot;</span>
                        <span class="s2">&quot;option to speed up database creation&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">featuretype</span> <span class="o">==</span> <span class="s2">&quot;gene&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_infer_genes</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;It appears you have a gene feature in your GTF &quot;</span>
                        <span class="s2">&quot;file. You may want to use the &quot;</span>
                        <span class="s2">&quot;`disable_infer_genes=True` &quot;</span>
                        <span class="s2">&quot;option to speed up database creation&quot;</span>
                    <span class="p">)</span>

            <span class="n">lines_seen</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># Percent complete</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_handler</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="c1"># Insert the feature itself...</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
                <span class="n">fixed</span><span class="p">,</span> <span class="n">final_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_merge</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_strategy</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">final_strategy</span> <span class="o">==</span> <span class="s2">&quot;merge&quot;</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        UPDATE features SET attributes = ?</span>
<span class="sd">                        WHERE id = ?</span>
<span class="sd">                        &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">fixed</span><span class="o">.</span><span class="n">attributes</span><span class="p">),</span> <span class="n">fixed</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="c1"># For any additional fields we&#39;re merging, update those as</span>
                    <span class="c1"># well.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_merge_fields</span><span class="p">:</span>
                        <span class="n">_set_clause</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = ?&quot;</span> <span class="o">%</span> <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_merge_fields</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">fixed</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_merge_fields</span>
                        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">fixed</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                            UPDATE features SET %s</span>
<span class="sd">                            WHERE id = ?</span>
<span class="sd">                            &quot;&quot;&quot;</span>
                            <span class="o">%</span> <span class="n">_set_clause</span><span class="p">,</span>
                            <span class="n">values</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">final_strategy</span> <span class="o">==</span> <span class="s2">&quot;replace&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">final_strategy</span> <span class="o">==</span> <span class="s2">&quot;create_unique&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

            <span class="c1"># For an on-spec GTF file,</span>
            <span class="c1"># self.transcript_key = &quot;transcript_id&quot;</span>
            <span class="c1"># self.gene_key = &quot;gene_id&quot;</span>
            <span class="n">relations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">grandparent</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transcript_key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attributes</span>
                <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">transcript_key</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">transcript_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parent</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                <span class="n">grandparent</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_key</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grandparent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">grandparent</span> <span class="o">=</span> <span class="n">grandparent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">grandparent</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">grandparent</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="c1"># Note the IGNORE, so relationships defined many times in the file</span>
            <span class="c1"># (e.g., the transcript-gene relation on pretty much every line in</span>
            <span class="c1"># a GTF) will only be included once.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                INSERT OR IGNORE INTO relations (parent, child, level)</span>
<span class="sd">                VALUES (?, ?, ?)</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">relations</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">lines_seen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No lines parsed -- was an empty file provided?&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Committing changes&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_infer_genes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_infer_transcripts</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># TODO: do any indexes speed this up?</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating relations(parent) index&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS relationsparent&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX relationsparent ON relations (parent)&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating relations(child) index&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS relationschild&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX relationschild ON relations (child)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_infer_genes</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_infer_transcripts</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;gene and transcript&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_infer_transcripts</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;gene&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_infer_genes</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;transcript&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Inferring </span><span class="si">%s</span><span class="s2"> extents &quot;</span> <span class="s2">&quot;and writing to tempfile&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keep_tempfiles</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_tempfiles</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;.gffutils&quot;</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmpfile</span> <span class="o">=</span> <span class="n">tmp</span>

            <span class="c1"># This takes some explanation...</span>
            <span class="c1">#</span>
            <span class="c1"># First, the nested subquery gets the level-1 parents of</span>
            <span class="c1"># self.subfeature featuretypes.  For an on-spec GTF file,</span>
            <span class="c1"># self.subfeature = &quot;exon&quot;. So this subquery translates to getting the</span>
            <span class="c1"># distinct level-1 parents of exons -- which are transcripts.</span>
            <span class="c1">#</span>
            <span class="c1"># OK, so this first subquery is now a list of transcripts; call it</span>
            <span class="c1"># &quot;firstlevel&quot;.</span>
            <span class="c1">#</span>
            <span class="c1"># Then join firstlevel on relations, but the trick is to now consider</span>
            <span class="c1"># each transcript a *child* -- so that relations.parent (on the first</span>
            <span class="c1"># line of the query) will be the first-level parent of the transcript</span>
            <span class="c1"># (the gene).</span>
            <span class="c1">#</span>
            <span class="c1">#</span>
            <span class="c1"># The result is something like:</span>
            <span class="c1">#</span>
            <span class="c1">#   transcript1     gene1</span>
            <span class="c1">#   transcript2     gene1</span>
            <span class="c1">#   transcript3     gene2</span>
            <span class="c1">#</span>
            <span class="c1"># Note that genes are repeated; below we need to ensure that only one</span>
            <span class="c1"># is added.  To ensure this, the results are ordered by the gene ID.</span>
            <span class="c1">#</span>
            <span class="c1"># By the way, we do this even if we&#39;re only looking for transcripts or</span>
            <span class="c1"># only looking for genes.</span>

            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                SELECT DISTINCT firstlevel.parent, relations.parent</span>
<span class="sd">                FROM (</span>
<span class="sd">                    SELECT DISTINCT parent</span>
<span class="sd">                    FROM relations</span>
<span class="sd">                    JOIN features ON features.id = relations.child</span>
<span class="sd">                    WHERE features.featuretype = ?</span>
<span class="sd">                    AND relations.level = 1</span>
<span class="sd">                )</span>
<span class="sd">                AS firstlevel</span>
<span class="sd">                JOIN relations ON firstlevel.parent = child</span>
<span class="sd">                WHERE relations.level = 1</span>
<span class="sd">                ORDER BY relations.parent</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subfeature</span><span class="p">,),</span>
            <span class="p">)</span>

            <span class="c1"># Now we iterate through those results (using a new cursor) to infer</span>
            <span class="c1"># the extent of transcripts and/or genes.</span>

            <span class="n">last_gene_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">n_features</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">transcript_id</span><span class="p">,</span> <span class="n">gene_id</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_infer_transcripts</span><span class="p">:</span>
                    <span class="c1"># transcript extent</span>
                    <span class="n">c2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        SELECT MIN(start), MAX(end), strand, seqid</span>
<span class="sd">                        FROM features</span>
<span class="sd">                        JOIN relations ON</span>
<span class="sd">                        features.id = relations.child</span>
<span class="sd">                        WHERE parent = ? AND featuretype == ?</span>
<span class="sd">                        &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">transcript_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subfeature</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">transcript_start</span><span class="p">,</span> <span class="n">transcript_end</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">seqid</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="n">transcript_attributes</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">transcript_key</span><span class="p">:</span> <span class="p">[</span><span class="n">transcript_id</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">gene_key</span><span class="p">:</span> <span class="p">[</span><span class="n">gene_id</span><span class="p">],</span>
                    <span class="p">}</span>
                    <span class="n">transcript_bin</span> <span class="o">=</span> <span class="n">bins</span><span class="o">.</span><span class="n">bins</span><span class="p">(</span>
                        <span class="n">transcript_start</span><span class="p">,</span> <span class="n">transcript_end</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

                    <span class="c1"># Write out to file; we&#39;ll be reading it back in shortly.  Omit</span>
                    <span class="c1"># score, frame, source, and extra since they will always have</span>
                    <span class="c1"># the same default values (&quot;.&quot;, &quot;.&quot;, &quot;gffutils_derived&quot;, and []</span>
                    <span class="c1"># respectively)</span>

                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="nb">map</span><span class="p">(</span>
                                <span class="nb">str</span><span class="p">,</span>
                                <span class="p">[</span>
                                    <span class="n">transcript_id</span><span class="p">,</span>
                                    <span class="n">seqid</span><span class="p">,</span>
                                    <span class="n">transcript_start</span><span class="p">,</span>
                                    <span class="n">transcript_end</span><span class="p">,</span>
                                    <span class="n">strand</span><span class="p">,</span>
                                    <span class="s2">&quot;transcript&quot;</span><span class="p">,</span>
                                    <span class="n">transcript_bin</span><span class="p">,</span>
                                    <span class="n">helpers</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">transcript_attributes</span><span class="p">),</span>
                                <span class="p">],</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="n">n_features</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_infer_genes</span><span class="p">:</span>
                    <span class="c1"># Infer gene extent, but only if we haven&#39;t done so already</span>
                    <span class="c1"># for this gene; recall we sorted by gene id so this check</span>
                    <span class="c1"># works</span>
                    <span class="k">if</span> <span class="n">gene_id</span> <span class="o">!=</span> <span class="n">last_gene_id</span><span class="p">:</span>
                        <span class="n">c2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                            SELECT MIN(start), MAX(end), strand, seqid</span>
<span class="sd">                            FROM features</span>
<span class="sd">                            JOIN relations ON</span>
<span class="sd">                            features.id = relations.child</span>
<span class="sd">                            WHERE parent = ? AND featuretype == ?</span>
<span class="sd">                            &quot;&quot;&quot;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">gene_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subfeature</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">gene_start</span><span class="p">,</span> <span class="n">gene_end</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">seqid</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                        <span class="n">gene_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_key</span><span class="p">:</span> <span class="p">[</span><span class="n">gene_id</span><span class="p">]}</span>
                        <span class="n">gene_bin</span> <span class="o">=</span> <span class="n">bins</span><span class="o">.</span><span class="n">bins</span><span class="p">(</span><span class="n">gene_start</span><span class="p">,</span> <span class="n">gene_end</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="nb">str</span><span class="p">,</span>
                                    <span class="p">[</span>
                                        <span class="n">gene_id</span><span class="p">,</span>
                                        <span class="n">seqid</span><span class="p">,</span>
                                        <span class="n">gene_start</span><span class="p">,</span>
                                        <span class="n">gene_end</span><span class="p">,</span>
                                        <span class="n">strand</span><span class="p">,</span>
                                        <span class="s2">&quot;gene&quot;</span><span class="p">,</span>
                                        <span class="n">gene_bin</span><span class="p">,</span>
                                        <span class="n">helpers</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">gene_attributes</span><span class="p">),</span>
                                    <span class="p">],</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                    <span class="n">last_gene_id</span> <span class="o">=</span> <span class="n">gene_id</span>
                    <span class="n">n_features</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="nf">derived_feature_generator</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generator of items from the file that was just created...</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;parent&quot;</span><span class="p">,</span>
                <span class="s2">&quot;seqid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;strand&quot;</span><span class="p">,</span>
                <span class="s2">&quot;featuretype&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;attributes&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fout</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">))))</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">)</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gffutils_derived&quot;</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;frame&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;extra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">_unjsonify</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">])</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_handler</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">f</span>

        <span class="c1"># Drop the indexes so the inserts are faster</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS relationsparent&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS relationschild&quot;</span><span class="p">)</span>

        <span class="c1"># Insert the just-inferred transcripts and genes.  TODO: should we</span>
        <span class="c1"># *always* use &quot;merge&quot; here for the merge_strategy?</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Importing inferred features into db&quot;</span><span class="p">)</span>
        <span class="n">last_perc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">derived_feature_generator</span><span class="p">()):</span>
            <span class="n">perc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">perc</span> <span class="o">!=</span> <span class="n">last_perc</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s%%</span><span class="s2">)</span><span class="se">\r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n_features</span><span class="p">,</span> <span class="n">perc</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">last_perc</span> <span class="o">=</span> <span class="n">perc</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
                <span class="n">fixed</span><span class="p">,</span> <span class="n">final_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_merge</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;merge&quot;</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    UPDATE features SET attributes = ?</span>
<span class="sd">                    WHERE id = ?</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">fixed</span><span class="o">.</span><span class="n">attributes</span><span class="p">),</span> <span class="n">fixed</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Committing changes&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_tempfiles</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fout</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># TODO: recreate indexes? Typically the _finalize() method will be</span>
        <span class="c1"># called after this one, and indexes are created in _finalize().</span>


<div class="viewcode-block" id="create_db"><a class="viewcode-back" href="../../autodocs/gffutils.create.create_db.html#gffutils.create.create_db">[docs]</a><span class="k">def</span> <span class="nf">create_db</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">dbfn</span><span class="p">,</span>
    <span class="n">id_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">checklines</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">merge_strategy</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">gtf_transcript_key</span><span class="o">=</span><span class="s2">&quot;transcript_id&quot;</span><span class="p">,</span>
    <span class="n">gtf_gene_key</span><span class="o">=</span><span class="s2">&quot;gene_id&quot;</span><span class="p">,</span>
    <span class="n">gtf_subfeature</span><span class="o">=</span><span class="s2">&quot;exon&quot;</span><span class="p">,</span>
    <span class="n">force_gff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">force_dialect_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">from_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">keep_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">text_factory</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">OptimizedUnicode</span><span class="p">,</span>
    <span class="n">force_merge_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pragmas</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">default_pragmas</span><span class="p">,</span>
    <span class="n">sort_attribute_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dialect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">_keep_tempfiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">infer_gene_extent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">disable_infer_genes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">disable_infer_transcripts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a database from a GFF or GTF file.</span>

<span class="sd">    For more details on when and how to use the kwargs below, see the examples</span>
<span class="sd">    in the online documentation (:ref:`examples`).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : string or iterable</span>

<span class="sd">        If a string (and `from_string` is False), then `data` is the path to</span>
<span class="sd">        the original GFF or GTF file.</span>

<span class="sd">        If a string and `from_string` is True, then assume `data` is the actual</span>
<span class="sd">        data to use.</span>

<span class="sd">        Otherwise, it&#39;s an iterable of Feature objects.</span>

<span class="sd">    dbfn : string</span>

<span class="sd">        Path to the database that will be created.  Can be the special string</span>
<span class="sd">        &quot;:memory:&quot; to create an in-memory database.</span>

<span class="sd">    id_spec : string, list, dict, callable, or None</span>

<span class="sd">        This parameter guides what will be used as the primary key for the</span>
<span class="sd">        database, which in turn determines how you will access individual</span>
<span class="sd">        features by name from the database.</span>

<span class="sd">        If an id spec is not otherwise specified for a featuretype (keep</span>
<span class="sd">        reading below for how to do this), or the provided id spec is not</span>
<span class="sd">        available for a particular feature (say, exons do not have &quot;ID&quot;</span>
<span class="sd">        attributes even though `id_spec=&quot;ID&quot;` was provided) then the default</span>
<span class="sd">        behavior is to autoincrement an ID for that featuretype. For example,</span>
<span class="sd">        if there is no id spec defined for an exon, then the ids for exons will</span>
<span class="sd">        take the form exon1, exon2, exon3, and so on. This ensures that each</span>
<span class="sd">        feature has a unique primary key in the database without requiring lots</span>
<span class="sd">        of configuration. However, if you want to be able to retrieve features</span>
<span class="sd">        based on their primary key, then it is worth the effort to provide an</span>
<span class="sd">        accurate id spec.</span>

<span class="sd">        If `id_spec=None`, then use the default behavior. The default behavior</span>
<span class="sd">        depends on the detected format (or forced format, e.g., if</span>
<span class="sd">        `force_gff=True`). For GFF files, the default is be `id_spec=&quot;ID&quot;`. For</span>
<span class="sd">        GTF files, the default is `id_spec={&#39;gene&#39;: &#39;gene_id&#39;, &#39;transcript&#39;:</span>
<span class="sd">        &#39;transcript_id&#39;}`.</span>

<span class="sd">        If `id_spec` is a string, then look for this key in the attributes.  If</span>
<span class="sd">        it exists, then use its value as the primary key, otherwise</span>
<span class="sd">        autoincrement based on the feature type.  For many GFF3 files, &quot;ID&quot;</span>
<span class="sd">        usually works well.</span>

<span class="sd">        If `id_spec` is a list or tuple of keys, then check for each one in</span>
<span class="sd">        order, using the first one found.  For GFF3, this might be modified to</span>
<span class="sd">        [&quot;ID&quot;, &quot;Name&quot;], which would use the ID if it exists, otherwise the</span>
<span class="sd">        Name, otherwise autoincrement based on the feature type.</span>

<span class="sd">        If `id_spec` is a dictionary, then it is a mapping of feature types to</span>
<span class="sd">        what should be used as the ID.  For example, for GTF files, `{&#39;gene&#39;:</span>
<span class="sd">        &#39;gene_id&#39;, &#39;transcript&#39;: &#39;transcript_id&#39;}` may be useful.  The values</span>
<span class="sd">        of this dictionary can also be a list, e.g., `{&#39;gene&#39;: [&#39;gene_id&#39;,</span>
<span class="sd">        &#39;geneID&#39;]}`.</span>

<span class="sd">        If `id_spec` is a callable object, then it accepts a dictionary from</span>
<span class="sd">        the iterator and returns one of the following:</span>

<span class="sd">            * None (in which case the feature type will be auto-incremented)</span>
<span class="sd">            * string (which will be used as the primary key)</span>
<span class="sd">            * special string starting with &quot;autoincrement:X&quot;, where &quot;X&quot; is</span>
<span class="sd">              a string that will be used for auto-incrementing.  For example,</span>
<span class="sd">              if &quot;autoincrement:chr10&quot;, then the first feature will be</span>
<span class="sd">              &quot;chr10_1&quot;, the second &quot;chr10_2&quot;, and so on.</span>

<span class="sd">    force : bool</span>

<span class="sd">        If `False` (default), then raise an exception if `dbfn` already exists.</span>
<span class="sd">        Use `force=True` to overwrite any existing databases.</span>

<span class="sd">    verbose : bool</span>

<span class="sd">        Report percent complete and other feedback on how the db creation is</span>
<span class="sd">        progressing.</span>

<span class="sd">        In order to report percent complete, the entire file needs to be read</span>
<span class="sd">        once to see how many items there are; for large files you may want to</span>
<span class="sd">        use `verbose=False` to avoid this.</span>

<span class="sd">    checklines : int</span>

<span class="sd">        Number of lines to check the dialect.</span>

<span class="sd">    merge_strategy : str</span>
<span class="sd">        One of {merge, create_unique, error, warning, replace}.</span>

<span class="sd">        This parameter specifies the behavior when two items have an identical</span>
<span class="sd">        primary key.</span>

<span class="sd">        Using `merge_strategy=&quot;merge&quot;`, then there will be a single entry in</span>
<span class="sd">        the database, but the attributes of all features with the same primary</span>
<span class="sd">        key will be merged. WARNING: this can be quite slow when incorrectly</span>
<span class="sd">        used.</span>

<span class="sd">        Using `merge_strategy=&quot;create_unique&quot;`, then the first entry will use</span>
<span class="sd">        the original primary key, but the second entry will have a unique,</span>
<span class="sd">        autoincremented primary key assigned to it</span>

<span class="sd">        Using `merge_strategy=&quot;error&quot;`, a :class:`gffutils.DuplicateID`</span>
<span class="sd">        exception will be raised.  This means you will have to edit the file</span>
<span class="sd">        yourself to fix the duplicated IDs.</span>

<span class="sd">        Using `merge_strategy=&quot;warning&quot;`, a warning will be printed to the</span>
<span class="sd">        logger, and the duplicate feature will be skipped.</span>

<span class="sd">        Using `merge_strategy=&quot;replace&quot;` will replace the entire existing</span>
<span class="sd">        feature with the new feature.</span>

<span class="sd">    transform : callable</span>

<span class="sd">        If not None, `transform` should accept a Feature object as its only</span>
<span class="sd">        argument and return either a (possibly modified) Feature object or</span>
<span class="sd">        a value that evaluates to False.  If the return value is False, the</span>
<span class="sd">        feature will be skipped.</span>

<span class="sd">    gtf_transcript_key, gtf_gene_key : string</span>

<span class="sd">        Which attribute to use as the transcript ID and gene ID respectively</span>
<span class="sd">        for GTF files.  Default is `transcript_id` and `gene_id` according to</span>
<span class="sd">        the GTF spec.</span>

<span class="sd">    gtf_subfeature : string</span>

<span class="sd">        Feature type to use as a &quot;gene component&quot; when inferring gene and</span>
<span class="sd">        transcript extents for GTF files.  Default is `exon` according to the</span>
<span class="sd">        GTF spec.</span>

<span class="sd">    force_gff : bool</span>
<span class="sd">        If True, do not do automatic format detection -- only use GFF.</span>

<span class="sd">    force_dialect_check : bool</span>
<span class="sd">        If True, the dialect will be checkef for every feature (instead of just</span>
<span class="sd">        `checklines` features).  This can be slow, but may be necessary for</span>
<span class="sd">        inconsistently-formatted input files.</span>

<span class="sd">    from_string : bool</span>
<span class="sd">        If True, then treat `data` as actual data (rather than the path to</span>
<span class="sd">        a file).</span>

<span class="sd">    keep_order : bool</span>

<span class="sd">        If True, all features returned from this instance will have the</span>
<span class="sd">        order of their attributes maintained.  This can be turned on or off</span>
<span class="sd">        database-wide by setting the `keep_order` attribute or with this</span>
<span class="sd">        kwarg, or on a feature-by-feature basis by setting the `keep_order`</span>
<span class="sd">        attribute of an individual feature.</span>

<span class="sd">        Note that a single order of attributes will be used for all features.</span>
<span class="sd">        Specifically, the order will be determined by the order of attribute</span>
<span class="sd">        keys in the first `checklines` of the input data. See</span>
<span class="sd">        helpers._choose_dialect for more information on this.</span>

<span class="sd">        Default is False, since this includes a sorting step that can get</span>
<span class="sd">        time-consuming for many features.</span>

<span class="sd">    infer_gene_extent : bool</span>
<span class="sd">        DEPRECATED in version 0.8.4. See `disable_infer_transcripts` and</span>
<span class="sd">        `disable_infer_genes` for more granular control.</span>

<span class="sd">    disable_infer_transcripts, disable_infer_genes : bool</span>
<span class="sd">        Only used for GTF files. By default -- and according to the GTF spec --</span>
<span class="sd">        we assume that there are no transcript or gene features in the file.</span>
<span class="sd">        gffutils then infers the extent of each transcript based on its</span>
<span class="sd">        constituent exons and infers the extent of each gene bases on its</span>
<span class="sd">        constituent transcripts.</span>

<span class="sd">        This default behavior is problematic if the input file already contains</span>
<span class="sd">        transcript or gene features (like recent GENCODE GTF files for human),</span>
<span class="sd">        since 1) the work to infer extents is unnecessary, and 2)</span>
<span class="sd">        trying to insert an inferred feature back into the database triggers</span>
<span class="sd">        gffutils&#39; feature-merging routines, which can get time consuming.</span>

<span class="sd">        The solution is to use `disable_infer_transcripts=True` if your GTF</span>
<span class="sd">        already has transcripts in it, and/or `disable_infer_genes=True` if it</span>
<span class="sd">        already has genes in it. This can result in dramatic (100x) speedup.</span>

<span class="sd">        Prior to version 0.8.4, setting `infer_gene_extents=False` would</span>
<span class="sd">        disable both transcript and gene inference simultaneously. As of</span>
<span class="sd">        version 0.8.4, these argument allow more granular control.</span>

<span class="sd">    force_merge_fields : list</span>
<span class="sd">        If merge_strategy=&quot;merge&quot;, then features will only be merged if their</span>
<span class="sd">        non-attribute values are identical (same chrom, source, start, stop,</span>
<span class="sd">        score, strand, phase).  Using `force_merge_fields`, you can override</span>
<span class="sd">        this behavior to allow merges even when fields are different.  This</span>
<span class="sd">        list can contain one or more of [&#39;seqid&#39;, &#39;source&#39;, &#39;featuretype&#39;,</span>
<span class="sd">        &#39;score&#39;, &#39;strand&#39;, &#39;frame&#39;].  The resulting merged fields will be</span>
<span class="sd">        strings of comma-separated values.  Note that &#39;start&#39; and &#39;end&#39; are not</span>
<span class="sd">        available, since these fields need to be integers.</span>

<span class="sd">    text_factory : callable</span>
<span class="sd">        Text factory to use for the sqlite3 database.  See</span>
<span class="sd">        https://docs.python.org/2/library/\</span>
<span class="sd">                sqlite3.html#sqlite3.Connection.text_factory</span>
<span class="sd">        for details. The default sqlite3.OptimizedUnicode will return Unicode</span>
<span class="sd">        objects only for non-ASCII data, and bytestrings otherwise.</span>

<span class="sd">    pragmas : dict</span>
<span class="sd">        Dictionary of pragmas used when creating the sqlite3 database. See</span>
<span class="sd">        http://www.sqlite.org/pragma.html for a list of available pragmas.  The</span>
<span class="sd">        defaults are stored in constants.default_pragmas, which can be used as</span>
<span class="sd">        a template for supplying a custom dictionary.</span>

<span class="sd">    sort_attribute_values : bool</span>
<span class="sd">        All features returned from the database will have their attribute</span>
<span class="sd">        values sorted.  Typically this is only useful for testing, since this</span>
<span class="sd">        can get time-consuming for large numbers of features.</span>

<span class="sd">    _keep_tempfiles : bool or string</span>
<span class="sd">        False by default to clean up intermediate tempfiles created during GTF</span>
<span class="sd">        import.  If True, then keep these tempfile for testing or debugging.</span>
<span class="sd">        If string, then keep the tempfile for testing, but also use the string</span>
<span class="sd">        as the suffix fo the tempfile. This can be useful for testing in</span>
<span class="sd">        parallel environments.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    New :class:`FeatureDB` object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_locals</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>

    <span class="c1"># Check if any older kwargs made it in</span>
    <span class="n">deprecation_handler</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">_locals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">_iterator_kwargs</span><span class="p">)</span>

    <span class="c1"># First construct an iterator so that we can identify the file format.</span>
    <span class="c1"># DataIterator figures out what kind of data was provided (string of lines,</span>
    <span class="c1"># filename, or iterable of Features) and checks `checklines` lines to</span>
    <span class="c1"># identify the dialect.</span>
    <span class="n">iterator</span> <span class="o">=</span> <span class="n">iterators</span><span class="o">.</span><span class="n">DataIterator</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">_locals</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dialect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dialect</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">dialect</span>

    <span class="c1"># However, a side-effect of this is that  if `data` was a generator, then</span>
    <span class="c1"># we&#39;ve just consumed `checklines` items (see</span>
    <span class="c1"># iterators.BaseIterator.__init__, which calls iterators.peek).</span>
    <span class="c1">#</span>
    <span class="c1"># But it also chains those consumed items back onto the beginning, and the</span>
    <span class="c1"># result is available as as iterator._iter.</span>
    <span class="c1">#</span>
    <span class="c1"># That&#39;s what we should be using now for `data:</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iterator</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;directives&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">directives</span>

    <span class="c1"># Since we&#39;ve already checked lines, we don&#39;t want to do it again</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;checklines&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">force_gff</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dialect</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;gff3&quot;</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">_GFFDBCreator</span>
        <span class="n">id_spec</span> <span class="o">=</span> <span class="n">id_spec</span> <span class="ow">or</span> <span class="s2">&quot;ID&quot;</span>
        <span class="n">add_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">id_spec</span><span class="o">=</span><span class="n">id_spec</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">dialect</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;gtf&quot;</span><span class="p">:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">_GTFDBCreator</span>
        <span class="n">id_spec</span> <span class="o">=</span> <span class="n">id_spec</span> <span class="ow">or</span> <span class="p">{</span><span class="s2">&quot;gene&quot;</span><span class="p">:</span> <span class="s2">&quot;gene_id&quot;</span><span class="p">,</span> <span class="s2">&quot;transcript&quot;</span><span class="p">:</span> <span class="s2">&quot;transcript_id&quot;</span><span class="p">}</span>
        <span class="n">add_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">transcript_key</span><span class="o">=</span><span class="n">gtf_transcript_key</span><span class="p">,</span>
            <span class="n">gene_key</span><span class="o">=</span><span class="n">gtf_gene_key</span><span class="p">,</span>
            <span class="n">subfeature</span><span class="o">=</span><span class="n">gtf_subfeature</span><span class="p">,</span>
            <span class="n">id_spec</span><span class="o">=</span><span class="n">id_spec</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">add_kwargs</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dialect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dialect</span>
    <span class="n">c</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dbfn</span> <span class="o">==</span> <span class="s2">&quot;:memory:&quot;</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">FeatureDB</span><span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span>
            <span class="n">keep_order</span><span class="o">=</span><span class="n">keep_order</span><span class="p">,</span>
            <span class="n">pragmas</span><span class="o">=</span><span class="n">pragmas</span><span class="p">,</span>
            <span class="n">sort_attribute_values</span><span class="o">=</span><span class="n">sort_attribute_values</span><span class="p">,</span>
            <span class="n">text_factory</span><span class="o">=</span><span class="n">text_factory</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">FeatureDB</span><span class="p">(</span>
            <span class="n">c</span><span class="p">,</span>
            <span class="n">keep_order</span><span class="o">=</span><span class="n">keep_order</span><span class="p">,</span>
            <span class="n">pragmas</span><span class="o">=</span><span class="n">pragmas</span><span class="p">,</span>
            <span class="n">sort_attribute_values</span><span class="o">=</span><span class="n">sort_attribute_values</span><span class="p">,</span>
            <span class="n">text_factory</span><span class="o">=</span><span class="n">text_factory</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">db</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2022, Ryan Dale.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>